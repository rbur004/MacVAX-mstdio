/* * Seek for standard library.  Coordinates with buffering. */#include	"mstdio.h"#include 	"macio.h"longmfseek(	M_FILE *iop,	long offset,	long ptrname){	register resync, c;	long p;	iop->_flag &= ~_MIOEOF;	if (iop->_flag&_MIOREAD) {		if (ptrname<2 && iop->_base &&			!(iop->_flag&_MIONBF)) {						/* In System V append mode _cnt is stored as a			 * negative number.  See _mfilbuf() for details.			 */			c = (iop->_flag&_MIOAPPEND) ? -iop->_cnt : iop->_cnt ;			p = offset;			if (ptrname==0)				p += c - mlseek(mfileno(iop),0L,1);			else				offset -= c;			if(!(iop->_flag&_MIORW) && c>0&&p<=c			    && p>=iop->_base-iop->_ptr){				iop->_ptr += (int)p;				/* In System V append mode _cnt is stored as a				 * negative number.  See _mfilbuf() for				 * details.				 */				if (iop->_flag&_MIOAPPEND)					iop->_cnt += (int)p;				else					iop->_cnt -= (int)p;				return(0);			}			resync = offset&01;		} else 			resync = 0;		if (iop->_flag & _MIORW) {			iop->_ptr = iop->_base;			iop->_flag &= ~_MIOREAD;			resync = 0;		}		p = mlseek(mfileno(iop), offset-resync, ptrname);		iop->_cnt = 0;		if (resync)			mgetc(iop);	}	else if (iop->_flag & (_MIOWRT|_MIORW)) {				/* Have to flush anything in the output buffer before		 * doing the lseek().  Fflush() will now reset the		 * the iop fields properly.		 */		mfflush(iop);		p = mlseek(mfileno(iop), offset, ptrname);	}	return(p==-1?-1:0);}