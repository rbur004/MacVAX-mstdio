/* * Return file offset. * Coordinates with buffering. */#include	"mstdio.h"#include	"file.h"#include	"macio.h"long mftell(	register M_FILE *iop){	long tres;	register adjust;	/* Assume no characters in the buffer.	 */	adjust = 0;	if (iop->_flag & _MIOREAD) 		/* If a read has been done then we have to subtract the		 * number of characters in the buffer from the current		 * file position.  This means the ajustment is the _cnt		 * in System V append mode, since it is stored as a negative		 * number in that case.  Otherwise it is the negation of the		 * _cnt.		 */		adjust = (iop->_flag & _MIOAPPEND) ? iop->_cnt : (-iop->_cnt);			else if (iop->_flag & (_MIOWRT|_MIORW)) {				if (iop->_flag & _MIOAPPEND)						/* If in System V style append mode, we have to			 * do a flush, because the file may have been			 * repositioned and subsequent writes may have			 * started writing to the buffer without			 * actually writing to the file.  If the flush			 * isn't done, the position returned would be			 * wherever the file is positioned rather than where			 * it would be if the when the buffered characters			 * are written.  Note that if no characters are			 * buffered the write/flush will not occur and the			 * file position will not change.			 */			(void)mfflush(iop);		else if ( (iop->_flag & _MIOWRT) && iop->_base)						/* Otherwise if characters have been written to the			 * buffer, then just add the number of characters			 * to the current file position.  NOTE that _base			 * is NULL if no reads or writes have been done, or			 * if the file is unbuffered.			 */			adjust = iop->_ptr - iop->_base;	} else		/* Illegal mode		 */		return(EOF);	tres = mlseek(mfileno(iop), 0L, L_INCR);	return( (tres<0) ? tres : tres + adjust );}